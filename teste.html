<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta viewport='width=device-width'>

<title>teste13</title>

<script src="https://apis.google.com/js/api:client.js"></script>
<script>
//https://developers.google.com/identity/sign-in/web/sign-in
//https://console.cloud.google.com/apis/credentials

//https://myaccount.google.com/permissions
//https://codebeautify.org/jsviewer

var token = '';
var usuario = ''; 

/*
validade do id_token, atualizar se menos de uma hora
date -I'seconds' --date '@1617166706' // descartar 3 últimos dígitos de expires_at
Expira em uma hora

log acesso com fetch

usuário logado mas não conectado ao app

usuario deslogado e não conectado ao app
20:02:31.220 update googleUser false teste.html:97:13
20:04:01.020 update googleUser true teste.html:84:13
20:04:01.022 signin true teste.html:62:13
20:04:02.869 login sucess teste.html:106:11
20:04:02.871 update googleUser true teste.html:84:13
20:04:34.622 update googleUser true teste.html:84:13
20:04:34.626 signin false teste.html:69:13


fazendo login em guia anônima:
19:45:31.333 Cookie “G_ENABLED_IDPS” will be soon rejected because it has the “SameSite” attribute set to “None” or an invalid value, without the “secure” attribute. To know more about the “SameSite“ attribute, read https://developer.mozilla.org/docs/Web/HTTP/Headers/Set-Cookie/SameSite cb=gapi.loaded_0:578:21
19:45:31.342 update googleUser false teste.html:97:13
19:46:30.797 login sucess teste.html:106:11
19:46:30.800 update googleUser true teste.html:84:13
19:46:30.802 signin true teste.html:62:13

19:54:31.446 update googleUser true teste.html:84:13
19:54:31.448 usuario: sed.decourt@gmail.com teste.html:89:13
19:54:31.449 token_id: undefined teste.html:90:13
19:54:31.450
Uncaught TypeError: document.getElementById(...) is null  teste.html:92:14
19:54:31.452 signin false teste.html:69:13
19:54:31.454 Uncaught TypeError: document.getElementById(...) is null teste.html:72:14
*/

var auth2;
var googleUser;

var startApp = function() {
  gapi.load('auth2', initSignIn);
};

var initSignIn = function() {
  auth2 = gapi.auth2.init({client_id: '330234016508-6d6d97vqrtofusi7f85c9t1iu6nmtced.apps.googleusercontent.com', scope:'profile email'});
  
//  auth2.attachClickHandler(document.getElementById('customBtn'), {}, onSucess, onFailure);
  auth2.attachClickHandler(document.getElementById('customBtn'), {}, undefined, undefined);
  
  auth2.isSignedIn.listen(signinChanged);

  auth2.currentUser.listen(userChanged);
  
  // Sign in the user if they are currently signed in.
  if (auth2.isSignedIn.get() == true) {
    auth2.signIn(); // |  signOut()
  }
  
  googleUser = auth2.currentUser.get();
  
  //updateGoogleUser();
};

var signinChanged = function (val) {
  if (val) {
    console.log('signin true');
    token = googleUser.getAuthResponse().id_token;                 // | expires_in | expires_at
    usuario = googleUser.getBasicProfile().getEmail();             // | getImageUrl() | getName()
    console.log('usuario: ' + usuario);
    console.log('token_id: ' + token);
  }
  else {
    console.log('signin false');
    token = '';
    usuario = '';
    document.getElementById('blogin').style.display = 'block'; // | "hidden"
    document.getElementById('bmail').style.display = 'none';   // | "visible"
  }
};

var userChanged = function (user) {
  googleUser = user;
  //updateGoogleUser();
};

var updateGoogleUser = function () {
  if (googleUser.getBasicProfile()) {
    console.log('update googleUser true');
    //document.getElementById('auth-response').innerText = JSON.stringify(googleUser.getAuthResponse()); // reloadAuthResponse | update
    
    token = googleUser.getAuthResponse().id_token;                 // | expires_in | expires_at
    usuario = googleUser.getBasicProfile().getEmail();             // | getImageUrl() | getName()
    console.log('usuario: ' + usuario);
    console.log('token_id: ' + token);
    
    document.getElementById('blogin').style.display = 'none'; // | "visible"
    document.getElementById('bmail').style.display = 'block'; // | "hidden"
    document.getElementById('mail').innerText = usuario;
  }
  else {
    console.log('update googleUser false');
    token = '';
    usuario = '';
    document.getElementById('blogin').style.display = 'block'; // | "hidden"
    document.getElementById('bmail').style.display = 'none';   // | "visible"
  }
};

var onSucess = function(googleUser) {
  console.log('login sucess');
  token = googleUser.getAuthResponse().id_token;
  usuario = googleUser.getBasicProfile().getEmail();
  console.log('usuario: ' + usuario);
  console.log('token_id: ' + token);
  
  document.getElementById('blogin').style.display = 'none'; // | "visible"
  document.getElementById('bmail').style.display = 'block'; // | "hidden"
  document.getElementById('mail').innerText = usuario;
}

var onFailure = function(error) {
  console.log('login failure');
  console.log(error);
  token = '';
  usuario = '';
  usuario = JSON.stringify(error);
  document.getElementById('blogin').style.display = 'block'; // | "hidden"
  document.getElementById('bmail').style.display = 'none'; // | "visible"
}

function anote() {
  let info = "ceejapd/index.html" + 
             "\nusuario: " + usuario + 
             "\nuserAgent: " + navigator.userAgent + 
             "\nscreen.width: " + screen.width + 
             "\nscreen.height: " + screen.height + 
             "\ninnerWidth: " + innerWidth + 
             "\ninnerHeight: " + innerHeight + 
             "\ndeviceMemory: " + navigator.deviceMemory + "GiB of RAM";

  fetch(
    "https://docs.google.com/forms/u/0/d/e/1FAIpQLSeH6hDfEOI6jvgDsdkuuUeah_FU3dPGxZZr-sBBkIjj4Hkwog/formResponse",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: 'entry.667481942=' + escape(info),
    }
  );
}

// HTTP GET and POST have limit of 2048 characters.

function avaliacao(){
  if (token === '') {
    window.alert('Precisa fazer login.');
  }
  else {
    document.getElementById('page').innerHTML = '<p class="erro">Aguarde 1 minuto. Gerando arquivo...</p>';
    document.getElementById('page').style.cursor = 'wait';
    
    let matricula = prompt('Digite o número da matrícula',);
     
    let s = document.createElement('script');
    s.src = 'https://script.google.com/macros/s/AKfycbyDVDL2ALsqcTbuEQZMopBdp7vEOKwgFFfLBgCk14_BCjj2stOaK4kcbi92-GDgXCDk/exec?matricula=' + matricula + '&token=' + token;
    document.body.appendChild(s);
  }
}

function passaporte(){
  if (token === '') {
    window.alert('Precisa fazer login.');
  }
  else {
    document.getElementById('page').innerHTML = '<p class="erro">Aguarde 1 minuto. Gerando arquivo...</p>';
    document.getElementById('page').style.cursor = 'wait';
    
    let matricula = prompt('Digite o número da matrícula',);
     
    let s = document.createElement('script');
    s.src = 'https://script.google.com/macros/s/AKfycbyn6PvKxfF4oF1tcr0zpQLILKi02ClCQmzBR3uSwTLqpqbeSXYrWy86TbRxR-hsJUta/exec?matricula=' + matricula + '&token=' + token;
    document.body.appendChild(s);
  }
}

</script>

<style>
body {
  height: 100%;
  background-color: #FFFFFF;
  font-family: 'Open Sans',sans-serif;
  color: #000000;
  font-size: 16px;
  line-height: 23px;
  text-align: justify;
  margin: 0px;
  padding: 5mm;
}

a:link    {color:#2160DE; text-decoration:none;}      /* unvisited link  */
a:visited {color:#2160DE; text-decoration:none;}      /* visited link    */
a:hover   {color:#2160DE; text-decoration:underline;} /* mouse over link */
a:active  {color:#2160DE; text-decoration:underline;} /* selected link   */

pre {
  color: #000000;
}

.erro {
  text-align: center;
  font-size: 14pt;
  line-height: 20pt;
  font-weight: bold;
  
  margin: 0px;
  padding-top: 2cm;
  padding-bottom: 2cm;
  width: 100vw;
  background-color: #FFFF77;
  position: fixed;
  top: 50%;
}

.link {
  cursor:pointer
}

.link:hover, .link:active {
  text-decoration:underline;
}

#customBtn {
  display: inline-block;
  background: #1a73e8;
  color: #ffffff;
  border: 1px solid transparent;
  font-size: 16px;
  line-height: 23px;
  margin-left: 10px;
  margin-right: 8px;
  min-width: 96px;
  padding: 9px 23px;
  text-align: center;
  vertical-align: middle;
  -moz-border-radius: 4px;
  border-radius: 4px;
  box-sizing: border-box;
}

#customBtn:hover {
  cursor: pointer;
}
</style>

</head>

<body onload='startApp()'>

<div id="page">

<br />

<div id="blogin"><div id="customBtn" class="customBtn" style="float:left">Fazer login</div><p>(<b>em guia anônima, não funciona</b>)</p><br/></div>
<p id="bmail">Usuário: <span id="mail" style='color:#DD4433'></span></p>

<br />

<p><a href="https://bit.ly/ceejaonline">Drive Livros</a></p>

<p onclick="avaliacao()" class='link' style='color:#22BB22'>Pegar avaliação</p>

<p onclick="passaporte()" class='link' style='color:#22BB22'>Ver notas (passaporte)</p>

<p><a href="https://bit.ly/escolapaulo">Formulário de rematrícula</a></p>

<br />


</div><!-- page -->

</body>
</html>
