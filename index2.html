<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta viewport='width=device-width' />

<title>busca_matricula</title>

<script>
let id = '';
let usuario = 'sed.decourt@gmail.com';
let token = 'GXSBYBJ0NO0';
let fetch_response_obj = {};
let busca_matricula_key = 'AKfycbxWqCXy2P1GmbgwzxSYhXe558UFCyL23FxVPh5a-0ePtB9OCEH58rs754P7NL8PbDG6';
let post_body = '';
</script>

<style>
body {
  height: 100%;
  background-color: #FFFFFF;
  font-family: 'Open Sans',sans-serif;
  color: #000000;
  font-size: 16px;
  line-height: 23px;
  text-align: justify;
  margin: 0px;
  padding: 5mm;
}

.erro {
  text-align: center;
  font-size: 14pt;
  line-height: 20pt;
  font-weight: bold;
  
  margin: 0px;
  padding-top: 2cm;
  padding-bottom: 2cm;
  width: 100%;
  background-color: #FFFF77;
  position: fixed;
  left: 0;
}

a:link    {color:#2160DE; text-decoration:none;}      /* unvisited link  */
a:visited {color:#2160DE; text-decoration:none;}      /* visited link    */
a:hover   {color:#2160DE; text-decoration:underline;} /* mouse over link */
a:active  {color:#2160DE; text-decoration:underline;} /* selected link   */

.link {
  cursor: pointer
}

.container {
  display: none;
  position: fixed;
  top: 0px;
  left: 0px;
  width: 100vw;
  height: 100vh;
  background: #6C7A89;
  opacity: 0.5;
}

.matricula {
  display: none;
  position: fixed;
  background: #bbeeff;
  opacity: 1;
  padding: 30px;
  border: 2px solid #AAAAAA;
  text-align: center;
}

</style>
</head>

<body id="body_id">
<div id="page">
<p id="busca_matricula" class="link" style="color:#DD6611">Consultar número de matrícula</p>

<br />

<p id="requerimento" class="link" style="color:#DD4433">Requerimento de matrícula</a></p>

</div><!-- page -->

<div id="container_id" class="container">
</div>

<div id="matricula_id" class="matricula">
  <p>Digite o número da matrícula:</p>
  <input 
    id="matricula_texto" 
    type="text" 
    pattern="[0-9]{6}" 
    maxlength="6" 
    style="margin:5px"
  >
  <input 
    id="matricula_button" 
    type="button" 
    value="ok" 
  >
</div>

<div id="busca_matricula_id" class="matricula">
  <p>Parte do nome:<input 
    id="busca_matricula_nome" 
    type="text" 
    value="jho.*oli" 
    pattern="\([a-zA-Z ]" 
    maxlength="50"
    minlength="6"
    style="margin:5px"
  ></p>
  <input 
    id="busca_matricula_button" 
    type="button" 
    value="ok" 
  >
</div>

<div id="aviso_id" class="matricula">
  <p id="aviso_mensagem_id"></p>
  <input id="aviso_button" type="button" value="ok">
</div>

<iframe id="hiddenFrame" name="hiddenFrame" style="display:none"></iframe>
<form id="informe_form" style='display:none' enctype="application/x-www-form-urlencoded" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSeH6hDfEOI6jvgDsdkuuUeah_FU3dPGxZZr-sBBkIjj4Hkwog/formResponse" method="POST" target="hiddenFrame">
<input id="informe_texto" name="entry.667481942" type="hidden">
</form>

<script>

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const informe = (mensagem) => {
  informe_texto.value = mensagem;
  informe_form.submit();
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const aviso = (mensagem) => {
  container_id.style.display = 'inline';
  aviso_id.style.display     = 'inline';
  aviso_mensagem_id.innerText = mensagem;
  
  aviso_id.style.left = (container_id.offsetWidth  - aviso_id.offsetWidth ) / 2 + 'px';
  aviso_id.style.top  = (container_id.offsetHeight - aviso_id.offsetHeight) / 2 + 'px';
  
  aviso_button.focus();
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

aviso_button.onclick = () => {
  aviso_id.style.display     = 'none';
  if (
    busca_matricula_id.style.display != 'inline'
  ) container_id.style.display = 'none';
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const set_cookie = tk => {
    document.cookie = `ceejapd=${tk};expires=2022-12-31T23:59:59.000Z;path=/ceejapd/;`;
    document.cookie = `usuario=${usuario};expires=2022-12-31T23:59:59.000Z;path=/ceejapd/;`;
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const fetch_erro = (mensagem) => {
  let obj_element = document.createElement('p');
  let obj_text = document.createTextNode(mensagem);
  
  obj_element.appendChild(obj_text);
  obj_element.setAttribute('id','erro');
  obj_element.setAttribute('class','erro');
//  obj_element.setAttribute('style','top:');
  
  document.body.innerHTML = '';
  document.body.appendChild(obj_element);
  
  erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const fetch_resposta = () => {
  if (fetch_response_obj.erro === undefined) {fetch_erro('ERRO: falta "erro" em fetch_response_obj'); return;}
  
  if (fetch_response_obj.erro !== '') {fetch_erro(fetch_response_obj.erro); return;}
  if (fetch_response_obj.token !== '') set_cookie(fetch_response_obj.token);
  
  if (fetch_response_obj.elemento === undefined) {fetch_erro('ERRO: falta "element" em fetch_response_obj'); return;}
  if (fetch_response_obj.texto === undefined) {fetch_erro('ERRO: falta "texto" em fetch_response_obj'); return;}
  
  let obj_element = document.createElement(fetch_response_obj.elemento);
  let obj_text = document.createTextNode(fetch_response_obj.texto);
  
  obj_element.appendChild(obj_text);
  document.body.innerHTML = '';
  document.body.appendChild(obj_element);
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const fetch_post = () => {
  fetch(
    'https://script.google.com/macros/s/' + busca_matricula_key + '/exec', 
    {
      method: "POST",
      mode: "cors",
      credentials: "omit",
      headers: {
        "Content-Type": "text/plain"
      },
      body: post_body
    }
  ) 
  .then(
    response => {
      if (response.status === 200) {
        response.json().then(
          value => { 
            fetch_response_obj = value;
            fetch_resposta();
          }
        )
      }
      else {
        console.log("> " + response.statusText);
      }
    }
  )
  .catch(
    (error) => {
      informe(`ERRO: ${id}: ${usuario}: ${error}`);
      
      page.innerHTML = '<p id="erro" class="erro">ERRO ao carregar. Informe o professor Tarciso.<br />WhatsApp: (19)99296-9405</p>';
      erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
    }
  );
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

busca_matricula.onclick = () => {
  id = 'busca_matricula';
  
  if (token === '') {
    aviso('ERRO: Precisa fazer login.\n\nToque no botão azul na primeira linha.');
    return;
  }
  
  container_id.style.display = 'inline';
  
  busca_matricula_id.style.display = 'inline';
  busca_matricula_id.style.left    = (container_id.offsetWidth  - busca_matricula_id.offsetWidth ) / 2 + 'px';
  busca_matricula_id.style.top     = (container_id.offsetHeight - busca_matricula_id.offsetHeight) / 2 + 'px';
  
  busca_matricula_nome.onkeyup = (e) => {
    if (e.keyCode == 13) busca_matricula_button.focus();
  }
  
  busca_matricula_button.onclick = () => {
    if (
      busca_matricula_nome.value.length < 6 || 
      busca_matricula_nome.value.length > 50 
    ) {aviso("A busca tem que ter pelo menos 6 caracteres."); busca_matricula_nome.focus(); return;}
    
    let nome = busca_matricula_nome.value;
    
    busca_matricula_id.remove();
    container_id.remove();
    page.innerHTML = '<p id="erro" class="erro">Aguarde um minuto. Procurando ...</p>';
    erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
    erro.style.cursor = 'wait';
    
    post_body = `{ "id": "busca_matricula", "usuario": "${usuario}", "token":"${token}", "nome":"${nome.replace(/'/g, '').toUpperCase()}" }`;
    
    fetch_post();
    
    return;
  }
  
  busca_matricula_nome.focus();
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

requerimento.onclick = () => {
  id = 'requerimento';
  
  if (token === '') {
    aviso('ERRO: Precisa fazer login.\n\nToque no botão azul na primeira linha.');
    return;
  }
  else {
    container_id.style.display = 'inline';
    
    matricula_id.style.display = 'inline';
    matricula_id.style.left = (container_id.offsetWidth  - matricula_id.offsetWidth ) / 2 + 'px';
    matricula_id.style.top  = (container_id.offsetHeight - matricula_id.offsetHeight) / 2 + 'px';
    
    matricula_texto.onkeydown = () => {
      if (event.keyCode == 13 && /[0-9]{6}/.test(matricula_texto.value)) {
        matricula_button.focus()
      }
    }
    
    let matricula = '';
    matricula_button.onclick = () => {
      if (/[0-9]{6}/.test(matricula_texto.value)) {
        matricula = matricula_texto.value;
        matricula_id.remove();
        container_id.remove();
        page.remove();
        
        let obj_element = document.createElement('p');
        let obj_text = document.createTextNode('Aguarde 1 minuto. Gerando arquivo...');
        
        obj_element.appendChild(obj_text);
        obj_element.setAttribute('id','erro');
        obj_element.setAttribute('class','erro');
        
        document.body.appendChild(obj_element);
        erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
        erro.style.cursor = 'wait';
        
        post_body = `{ "id": "${id}", "usuario": "${usuario}", "token":"${token}", "matricula":"${matricula}" }`;
        
        fetch_post();
      }
    }

    matricula_texto.focus();
  }
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

</script>

</body>
</html>
