<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta viewport='width=device-width' />

<title>busca_matricula</title>

<script>
var auth2;
var googleUser;

let id = '';
let usuario = '';
let token = '';
let fetch_response_obj = {};
let busca_matricula_key = 'AKfycbzL8zTKiCEEQpwr8yJ89K9NeJnIYxLeVquRcd5AspOVN5iXrRJ9qUcdxwkbC7eFlGmE';
let post_body = '';

function getCookie(cname) {
  let name = cname + "=";
  let ca = document.cookie.split(';');
  for(let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') c = c.substring(1);
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

token = getCookie("ceejapd");
usuario = getCookie("usuario");

console.log('usuario: ' + usuario + ' token: ' + token);
  
if (token === '') {
  let s = document.createElement('script');
  s.src = 'https://apis.google.com/js/api:client.js';
  document.head.appendChild(s);
}

function recarregar() {
  if (document.getElementById('customBtn').style.display != 'none') {
    //informe('recarregar: ' + usuario + ': aparelho: ' + navigator.userAgent.replace(/^[^(]+\(([^)]+)\).*$/,'$1'));
    location.reload();
  }
}
  
var startApp = function() {
  //informe('Cookie: ' + document.cookie + ' | aparelho: ' + navigator.userAgent);
  //setTimeout(recarregar, 20000);
  
  if (token === '') {
    gapi.load('auth2', initSignIn);
  }
  else {
    document.getElementById('customBtn').style.display = 'none';
    document.getElementById('bmail').style.display = 'block';
    document.getElementById('mail').innerText = usuario;
    //informe('login: ' + usuario + ' | aparelho: ' + navigator.userAgent.replace(/^[^(]+\(([^)]+)\).*$/,'$1'));
  }
};

var initSignIn = function() {
  auth2 = gapi.auth2.init({client_id: '424899238646-9rov4v21n8936trraugrl3vcb3cs54id.apps.googleusercontent.com', scope:'profile email'});
  
  auth2.attachClickHandler(document.getElementById('customBtn'), {}, null, null);
  
  auth2.isSignedIn.listen(signinChanged);

  if (auth2.isSignedIn.get() == true) {
    auth2.signIn(); // |  signOut()
  }
};

var signinChanged = function(val) {
  if (val) {
    token = auth2.currentUser.get().getAuthResponse().id_token;
    usuario = auth2.currentUser.get().getBasicProfile().getEmail();             // | getImageUrl() | getName()
    //console.log('usuario: ' + usuario + ' token: ' + token);
    
    document.getElementById('customBtn').style.display = 'none';
    document.getElementById('bmail').style.display = 'block';
    document.getElementById('mail').innerText = usuario;
    //informe('login: ' + usuario + ' > aparelho: ' + navigator.userAgent.replace(/^[^(]+\(([^)]+)\).*$/,'$1'));
  }
  else {
    token = '';
    usuario = '';
    document.getElementById('bmail').style.display = 'none';
    document.getElementById('customBtn').style.display = 'inline';
  }
};

function sair() {
  //informe('logout: ' + usuario + ' | aparelho: ' + navigator.userAgent.replace(/^[^(]+\(([^)]+)\).*$/,'$1'));
  document.cookie = "ceejapd=;expires=1970-01-01T00:00:00.000Z;path=/ceejapd/;";
  document.cookie = "usuario=;expires=1970-01-01T00:00:00.000Z;path=/ceejapd/;";
  if (auth2 == undefined) location.reload();
  else { auth2.signOut(); location.reload();}
  //else window.location.href = "https://accounts.google.com/Logout";
  
  //auth2.signOut();
};



</script>

<style>
body {
  height: 100%;
  background-color: #FFFFFF;
  font-family: 'Open Sans',sans-serif;
  color: #000000;
  font-size: 16px;
  line-height: 23px;
  text-align: justify;
  margin: 0px;
  padding: 5mm;
}

h1 {
  text-align: center;
}

.erro {
  text-align: center;
  font-size: 14pt;
  line-height: 20pt;
  font-weight: bold;
  
  margin: 0px;
  padding-top: 2cm;
  padding-bottom: 2cm;
  width: 100%;
  background-color: #FFFF77;
  position: fixed;
  left: 0;
}

a:link    {color:#2160DE; text-decoration:none;}      /* unvisited link  */
a:visited {color:#2160DE; text-decoration:none;}      /* visited link    */
a:hover   {color:#2160DE; text-decoration:underline;} /* mouse over link */
a:active  {color:#2160DE; text-decoration:underline;} /* selected link   */

.link {
  cursor: pointer
}

.container {
  display: none;
  position: fixed;
  top: 0px;
  left: 0px;
  width: 100vw;
  height: 100vh;
  background: #6C7A89;
  opacity: 0.5;
}

.matricula {
  display: none;
  position: fixed;
  background: #bbeeff;
  opacity: 1;
  padding: 30px;
  border: 2px solid #AAAAAA;
  text-align: center;
}

#customBtn {
  display: inline-block;
  background: #1a73e8;
  color: #ffffff;
  border: 1px solid transparent;
  font-size: 16px;
  line-height: 23px;
  margin-left: 10px;
  margin-right: 8px;
  min-width: 96px;
  padding: 9px 23px;
  text-align: center;
  vertical-align: middle;
  -moz-border-radius: 4px;
  border-radius: 4px;
  box-sizing: border-box;
}

#customBtn:hover {
  cursor: pointer;
}

table, td, th {
  border: 1px solid black;
}

table { 
  border-collapse: collapse;
}
</style>
</head>

<body id="body_id" onload='startApp()'>
<div id="page">
<br />

<div id="customBtn" class="customBtn">Fazer login</div>
<p id="bmail" style="display:none">Usuário: <span id="mail" style='color:#DD4433'></span>
  <span onclick="sair();" style="background:#cccccc;border: 1px solid #000000; margin-left:10px; margin-right:8px; min-width:96px; padding: 9px 23px; text-align:center; vertical-align:middle; -moz-border-radius:4px; border-radius:4px; box-sizing: border-box; cursor:pointer;">Sair</span>
</p>

<br />
<br />

<p><a href="https://bit.ly/escolapaulo">Formulário de matrícula</a></p>

<p><a href="https://www.google.com/maps/dir//-22.856400368690867,-47.04246102053969/">Rota para CEEJA Paulo Decourt</a></p>

<p><a href="https://youtube.com/channel/UCxd2y8b5DYrjH4yTHOwzxKg/videos">Dicas no Youtube</a></p>

<p><a href="https://bit.ly/ceejaonline">Drive Livros</a></p>

<br />
<br/>

<p id="passaporte" class='link' style='color:#22BB22'>Ver notas (passaporte)</p>

<br />

<p id="mkboletim" class='link' style='color:#DD6611'>Gerar boletim</p>

<br />

<p id="busca_matricula" class="link" style="color:#DD6611">Consultar número de matrícula</p>

<br />

<p id="requerimento" class="link" style="color:#DD4433">Requerimento de matrícula</a></p>

</div><!-- page -->

<div id="container_id" class="container">
</div>

<div id="matricula_id" class="matricula">
  <p>Digite o número da matrícula:</p>
  <input 
    id="matricula_texto" 
    type="text" 
    pattern="[0-9]{6}" 
    maxlength="6" 
    style="margin:5px"
  >
  <input 
    id="matricula_button" 
    type="button" 
    value="ok" 
  >
</div>

<div id="busca_matricula_id" class="matricula">
  <p>Parte do nome:<input 
    id="busca_matricula_nome" 
    type="text" 
    value="jho.*oli" 
    pattern="\([a-zA-Z ]" 
    maxlength="50"
    minlength="6"
    style="margin:5px"
  ></p>
  <input 
    id="busca_matricula_button" 
    type="button" 
    value="ok" 
  >
</div>

<div id="mkboletim_id" class="matricula" style="text-align: left">
  <p>Matrícula:<input 
    id="mkboletim_matricula" 
    type="text" 
    pattern="[0-9]{6}" 
    maxlength="6" 
    style="margin:5px"
  ></p>
  <p>Disciplina: <select id="mkboletim_disciplina" style="margin:5px">
    <option value='Selecione'>Selecione</option>
    <option value='Arte'>Arte</option>
    <option value='Biologia'>Biologia</option>
    <option value='Filosofia'>Filosofia</option>
    <option value='Física'>Física</option>
    <option value='Geografia'>Geografia</option>
    <option value='História'>História</option>
    <option value='Inglês'>Inglês</option>
    <option value='Língua Portuguesa'>Língua Portuguesa</option>
    <option value='Matemática'>Matemática</option>
    <option value='Química'>Química</option>
    <option value='Sociologia'>Sociologia</option>
  </select></p>
  <p style="text-align: center"><input 
    id="mkboletim_button" 
    type="button" 
    value="ok" 
  ></p>
</div>

<div id="aviso_id" class="matricula">
  <p id="aviso_mensagem_id"></p>
  <input id="aviso_button" type="button" value="ok">
</div>

<iframe id="hiddenFrame" name="hiddenFrame" style="display:none"></iframe>
<form id="informe_form" style='display:none' enctype="application/x-www-form-urlencoded" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSeH6hDfEOI6jvgDsdkuuUeah_FU3dPGxZZr-sBBkIjj4Hkwog/formResponse" method="POST" target="hiddenFrame">
<input id="informe_texto" name="entry.667481942" type="hidden">
</form>

<script>

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const informe = (mensagem) => {
  informe_texto.value = mensagem;
  informe_form.submit();
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const aviso = (mensagem) => {
  container_id.style.display = 'inline';
  aviso_id.style.display     = 'inline';
  aviso_mensagem_id.innerText = mensagem;
  
  aviso_id.style.left = (container_id.offsetWidth  - aviso_id.offsetWidth ) / 2 + 'px';
  aviso_id.style.top  = (container_id.offsetHeight - aviso_id.offsetHeight) / 2 + 'px';
  
  aviso_button.focus();
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

aviso_button.onclick = () => {
  aviso_id.style.display     = 'none';
  if (
    busca_matricula_id.style.display != 'inline'
  ) container_id.style.display = 'none';
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const set_cookie = tk => {
    document.cookie = `ceejapd=${tk};expires=2022-12-31T23:59:59.000Z;path=/ceejapd/;`;
    document.cookie = `usuario=${usuario};expires=2022-12-31T23:59:59.000Z;path=/ceejapd/;`;
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const fetch_erro = (mensagem) => {
  let obj_element = document.createElement('p');
  let obj_text = document.createTextNode(mensagem);
  
  obj_element.appendChild(obj_text);
  obj_element.setAttribute('id','erro');
  obj_element.setAttribute('class','erro');
//  obj_element.setAttribute('style','top:');
  
  document.body.innerHTML = '';
  document.body.appendChild(obj_element);
  
  erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const fetch_resposta = () => {
  if (fetch_response_obj.erro === undefined) {fetch_erro('ERRO: falta "erro" em fetch_response_obj'); return;}
  
  if (fetch_response_obj.erro !== '') {fetch_erro(fetch_response_obj.erro); return;}
  if (fetch_response_obj.token !== '') set_cookie(fetch_response_obj.token);
  
  if (fetch_response_obj.elemento === undefined) {fetch_erro('ERRO: falta "element" em fetch_response_obj'); return;}
  if (fetch_response_obj.texto === undefined) {fetch_erro('ERRO: falta "texto" em fetch_response_obj'); return;}
  
  document.body.innerHTML = '';
  
  let obj_element = document.createElement(fetch_response_obj.elemento);
  obj_element.innerHTML = fetch_response_obj.texto;
  document.body.appendChild(obj_element);
  
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const fetch_post = () => {
  fetch(
    'https://script.google.com/macros/s/' + busca_matricula_key + '/exec', 
    {
      method: "POST",
      mode: "cors",
      credentials: "omit",
      headers: {
        "Content-Type": "text/plain"
      },
      body: post_body
    }
  ) 
  .then(
    response => {
      if (response.status === 200) {
        response.json().then(
          value => { 
            fetch_response_obj = value;
            fetch_resposta();
          }
        )
      }
      else {
        console.log("> " + response.statusText);
      }
    }
  )
  .catch(
    (error) => {
      informe(`ERRO: ${id}: ${usuario}: ${error}`);
      
      page.innerHTML = '<p id="erro" class="erro">ERRO ao carregar. Informe o professor Tarciso.<br />WhatsApp: (19)99296-9405</p>';
      erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
    }
  );
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

const entrar_matricula = () => {
  if (token === '') {
    aviso('ERRO: Precisa fazer login.\n\nToque no botão azul na primeira linha.');
    return;
  }
  
  container_id.style.display = 'inline';
  
  matricula_id.style.display = 'inline';
  matricula_id.style.left = (container_id.offsetWidth  - matricula_id.offsetWidth ) / 2 + 'px';
  matricula_id.style.top  = (container_id.offsetHeight - matricula_id.offsetHeight) / 2 + 'px';
  
  let matricula = '';
  matricula_texto.value = '';
  matricula_texto.onkeyup = () => {
    if (/[0-9]{6}/.test(matricula_texto.value)) {
      matricula = matricula_texto.value;
      matricula_button.focus()
    }
  }
  
  matricula_button.onclick = () => {
    if (/[0-9]{6}/.test(matricula_texto.value)) {
      matricula_id.remove();
      container_id.remove();
      page.innerHTML = '<p id="erro" class="erro">Aguarde 1 minuto. Gerando arquivo...</p>';
      erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
      erro.style.cursor = 'wait';
      
      post_body = `{ "id": "${id}", "usuario": "${usuario}", "token":"${token}", "matricula":"${matricula}" }`;
      
      fetch_post();
    }
  }
  
  matricula_texto.focus();
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

passaporte.onclick = () => {
  id = 'passaporte';
  entrar_matricula();
  return;
}

requerimento.onclick = () => {
  id = 'requerimento';
  entrar_matricula();
  return;
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

mkboletim.onclick = () => {
  id = 'mkboletim';
  
  if (token === '') {
    aviso('ERRO: Precisa fazer login.\n\nToque no botão azul na primeira linha.');
    return;
  }
  
  container_id.style.display = 'inline';
  
  mkboletim_id.style.display = 'inline';
  mkboletim_id.style.left = (container_id.offsetWidth  - mkboletim_id.offsetWidth ) / 2 + 'px';
  mkboletim_id.style.top  = (container_id.offsetHeight - mkboletim_id.offsetHeight) / 2 + 'px';
  
  mkboletim_matricula.value = '';
  let mkboletim_matricula_value = '';
  mkboletim_matricula.onkeyup = () => {
    if (/[0-9]{6}/.test(mkboletim_matricula.value)) {
      mkboletim_matricula_value = mkboletim_matricula.value;
      mkboletim_disciplina.focus();
    }
  }
  
  mkboletim_disciplina.value = 'Selecione';
  let mkboletim_disciplina_value = 'Selecione';
  mkboletim_disciplina.onchange = () => {
    mkboletim_disciplina_value = mkboletim_disciplina.value;
    mkboletim_button.focus();
  }
  
  mkboletim_button.onclick = () => {
    if (/[0-9]{6}/.test(mkboletim_matricula_value) && mkboletim_disciplina_value !== 'Selecione') {
      mkboletim_id.remove();
      container_id.remove();
      page.innerHTML = '<p id="erro" class="erro">Aguarde 1 minuto. Gerando arquivo...</p>';
      erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
      erro.style.cursor = 'wait';
      
      post_body = `{ "id": "${id}", "usuario": "${usuario}", "token":"${token}", "matricula":"${mkboletim_matricula_value}", "disciplina": "${mkboletim_disciplina_value}" }`;
      
      fetch_post();
    }
    else if (mkboletim_disciplina_value === 'Selecione') {
      mkboletim_disciplina.focus();
    }
    else {
      mkboletim_matricula.focus();
    }
  }
  
  mkboletim_matricula.focus();
}

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

busca_matricula.onclick = () => {
  id = 'busca_matricula';
  
  if (token === '') {
    aviso('ERRO: Precisa fazer login.\n\nToque no botão azul na primeira linha.');
    return;
  }
  
  container_id.style.display = 'inline';
  
  busca_matricula_id.style.display = 'inline';
  busca_matricula_id.style.left    = (container_id.offsetWidth  - busca_matricula_id.offsetWidth ) / 2 + 'px';
  busca_matricula_id.style.top     = (container_id.offsetHeight - busca_matricula_id.offsetHeight) / 2 + 'px';
  
  busca_matricula_nome.onkeyup = (e) => {
    if (e.keyCode == 13) busca_matricula_button.focus();
  }
  
  busca_matricula_button.onclick = () => {
    if (
      busca_matricula_nome.value.length < 6 || 
      busca_matricula_nome.value.length > 50 
    ) {aviso("A busca tem que ter pelo menos 6 caracteres."); busca_matricula_nome.focus(); return;}
    
    let nome = busca_matricula_nome.value;
    
    busca_matricula_id.remove();
    container_id.remove();
    page.innerHTML = '<p id="erro" class="erro">Aguarde um minuto. Procurando ...</p>';
    erro.style.top = (innerHeight - erro.offsetHeight) / 2 + 'px';
    erro.style.cursor = 'wait';
    
    post_body = `{ "id": "busca_matricula", "usuario": "${usuario}", "token":"${token}", "nome":"${nome.replace(/'/g, '').toUpperCase()}" }`;
    
    fetch_post();
    
    return;
  }
  
  busca_matricula_nome.focus();
  
  return;
}


// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

</script>

</body>
</html>
